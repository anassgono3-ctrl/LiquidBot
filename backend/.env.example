# Example configuration emphasizing header-mode usage

PORT=3000
NODE_ENV=development

USE_MOCK_SUBGRAPH=false
# Header-mode endpoint (preferred: key not in URL)
SUBGRAPH_URL=https://gateway.thegraph.com/api/subgraphs/id/GQFbb95cE6d8mV989mL5figjaGaKCQB3xqYrr1bRyXqF
GRAPH_API_KEY=replace_with_gateway_key

# (If you omit SUBGRAPH_URL the service defaults to path-embedded:
# https://gateway.thegraph.com/api/<GRAPH_API_KEY>/subgraphs/id/<DEPLOYMENT_ID>
# )

SUBGRAPH_POLL_INTERVAL_MS=15000

# Liquidation Tracking
# Maximum liquidations to fetch per poll (default: 50)
LIQUIDATION_POLL_LIMIT=50
# Maximum unique liquidation IDs to track (default: 5000)
LIQUIDATION_TRACK_MAX=5000

# Resilience & Metrics
SUBGRAPH_FAILURE_THRESHOLD=5
SUBGRAPH_RETRY_ATTEMPTS=3
SUBGRAPH_RETRY_BASE_MS=150
SUBGRAPH_RATE_LIMIT_CAPACITY=30
SUBGRAPH_RATE_LIMIT_INTERVAL_MS=10000

# Database
DATABASE_URL=postgres://postgres:postgres@localhost:5432/liquidbot

# Redis (choose either URL or host/port)
REDIS_HOST=127.0.0.1
REDIS_PORT=6379
# REDIS_URL=redis://127.0.0.1:6379

# Aave Pool (Base)
AAVE_POOL_ADDRESS=0xA238Dd80C259a72e81d7e4664a9801593F98d1c5

# Aave V3 Pool for health factor checks (optional - defaults to Base V3 Pool if not set)
# Used by ExecutionService to verify user is liquidatable before executing
# AAVE_POOL=0xA238Dd80C259a72e81d7e4664a9801593F98d1c5

# Aave V3 Base Data Provider Addresses (for dynamic liquidation sizing)
AAVE_ADDRESSES_PROVIDER=0xe20fCBdBfFC4Dd138cE8b2E6FBb6CB49777ad64D
AAVE_PROTOCOL_DATA_PROVIDER=0xC4Fcf9893072d61Cc2899C0054877Cb752587981
AAVE_ORACLE=0x2Cc0Fc26eD4563A5ce5e8bdcfe1A2878676Ae156
AAVE_POOL_CONFIGURATOR=0x5731a04B1E775f0fdd454Bf70f3335886e9A96be
AAVE_UI_POOL_DATA_PROVIDER=0x68100bD5345eA474D93577127C11F39FF8463e93
AAVE_WRAPPED_TOKEN_GATEWAY=0xa0d9C1E9E48Ca30c8d8C3B5D69FF5dc1f6DFfC24

# Auth
JWT_SECRET=replace_me
API_KEY=dev_key

# Debug deeper subgraph errors
# SUBGRAPH_DEBUG_ERRORS=true

# Telegram Notifications (optional - will be disabled if not set)
TELEGRAM_BOT_TOKEN=your_bot_token_here
TELEGRAM_CHAT_ID=your_chat_id_here

# Health Monitoring (thresholds kept for reference, monitoring disabled)
HEALTH_ALERT_THRESHOLD=1.10
HEALTH_EMERGENCY_THRESHOLD=1.05

# Profit Estimation
PROFIT_FEE_BPS=30
PROFIT_MIN_USD=10

# Price Oracle (placeholder for future integration)
PRICE_ORACLE_MODE=coingecko

# Health Factor Resolution Mode
# Note: Bulk monitoring disabled. Health factors resolved on-demand per liquidation.
HEALTH_QUERY_MODE=on_demand

# Poll Configuration
# Maximum new liquidations to process per poll (default: 5)
POLL_LIMIT=5
# Ignore first (bootstrap) batch for notifications/opportunity pipeline (default: true)
IGNORE_BOOTSTRAP_BATCH=true

# Gas Cost Estimation
# Gas cost in USD for profit calculations (default: 0)
GAS_COST_USD=0

# Chainlink Price Feeds (optional - falls back to stub prices if not configured)
# RPC URL for Chainlink price feed queries
# CHAINLINK_RPC_URL=https://mainnet.base.org
# Comma-separated list of token:feedAddress pairs
# CHAINLINK_FEEDS=ETH:0x71041dddad3595F9CEd3DcCFBe3D1F4b0a16Bb70,USDC:0x7e860098F58bBFC8648a4311b374B1D669a2bc6B

# At-Risk User Scanning (Optional)
# Number of users to scan per poll cycle (0 disables scanning)
AT_RISK_SCAN_LIMIT=50
# Health factor threshold for warning tier (HF below this triggers warning)
AT_RISK_WARN_THRESHOLD=1.05
# Health factor threshold for critical tier (HF below this is liquidatable)
AT_RISK_LIQ_THRESHOLD=1.0
# Debt threshold in ETH below which debt is considered dust (effectively zero)
AT_RISK_DUST_EPSILON=1e-9
# Whether to send notifications for critical tier users (default: true)
AT_RISK_NOTIFY_CRITICAL=true
# Whether to send notifications for warn tier users (default: false)
AT_RISK_NOTIFY_WARN=false

# Subgraph Feature Gating
# Master switch to enable/disable subgraph usage (default: false)
# When false: relies on on-chain discovery only via real-time events and startup backfill
# When true: uses subgraph for candidate seeding (requires GRAPH_API_KEY + SUBGRAPH_DEPLOYMENT_ID)
USE_SUBGRAPH=false
# Subgraph refresh interval in minutes for periodic candidate discovery (default: 30)
# Used by SubgraphSeeder to periodically refresh the full user universe
SUBGRAPH_REFRESH_MINUTES=30

# On-Chain Backfill for Candidate Discovery (default path when USE_SUBGRAPH=false)
# Enable/disable initial on-chain backfill on startup (default: true)
REALTIME_INITIAL_BACKFILL_ENABLED=true
# Number of blocks to scan backward from current block (default: 50000)
REALTIME_INITIAL_BACKFILL_BLOCKS=50000
# Size of each chunk when scanning logs (default: 2000)
REALTIME_INITIAL_BACKFILL_CHUNK_BLOCKS=2000
# Maximum number of logs to scan before stopping (default: 20000)
REALTIME_INITIAL_BACKFILL_MAX_LOGS=20000
# Optional dedicated RPC URL for backfill (recommended: use HTTP for backfill, WS for real-time)
# If not set, reuses the WS_RPC_URL provider
# Examples:
#   BACKFILL_RPC_URL=https://mainnet.base.org  (HTTP/HTTPS provider)
#   BACKFILL_RPC_URL=wss://mainnet.base.org     (WebSocket provider)
# BACKFILL_RPC_URL=

# Subgraph Paging (only when USE_SUBGRAPH=true)
# Page size for subgraph queries (min: 50, max: 1000, default: 100)
# Note: The Graph enforces a max of 1000 results per query
SUBGRAPH_PAGE_SIZE=100

# Head-Check Paging/Rotation (on-chain health factor checks)
# Strategy for head checks: 'all' or 'paged' (default: paged)
# - all: check all candidates every block (high RPC usage)
# - paged: rotate through candidates to reduce load
HEAD_CHECK_PAGE_STRATEGY=paged
# Number of candidates to include per head cycle when using paged strategy (default: 250)
HEAD_CHECK_PAGE_SIZE=250

# Execution Scaffold (default: disabled for safety)
# Master switch to enable execution (default: false)
EXECUTION_ENABLED=false
# Dry run mode - simulate without broadcasting transactions (default: true)
DRY_RUN_EXECUTION=true
# Optional MEV relay URL (e.g., https://rpc.flashbots.net)
# PRIVATE_BUNDLE_RPC=
# Maximum allowed gas price in Gwei (default: 50)
MAX_GAS_PRICE_GWEI=50
# Minimum profit after gas costs in USD (default: 10)
MIN_PROFIT_AFTER_GAS_USD=10
# Maximum position size in USD (default: 5000)
MAX_POSITION_SIZE_USD=5000
# Daily loss limit in USD (default: 1000)
DAILY_LOSS_LIMIT_USD=1000
# Comma-separated list of blacklisted token symbols (e.g., WBTC,XYZ)
# BLACKLISTED_TOKENS=

# On-Chain Executor Configuration
# Deployed LiquidationExecutor contract address
# EXECUTOR_ADDRESS=0x...
# Private key for execution transactions (keep secure!)
# EXECUTION_PRIVATE_KEY=0x...
# RPC URL for Base network
# RPC_URL=https://mainnet.base.org
# Chain ID for Base
CHAIN_ID=8453
# 1inch API key for swap quotes (optional - falls back to v5 public API if not set)
# ONEINCH_API_KEY=your_api_key_here
# 1inch API base URL (auto-configured based on API key presence)
# v6 with API key: https://api.1inch.dev/swap/v6.0/8453
# v5 without API key: https://api.1inch.exchange/v5.0/8453
ONEINCH_BASE_URL=https://api.1inch.dev/swap/v6.0/8453
# Maximum slippage in basis points (100 = 1%)
MAX_SLIPPAGE_BPS=100
# Close factor mode: auto or fixed (default: auto) - LEGACY, see CLOSE_FACTOR_EXECUTION_MODE
CLOSE_FACTOR_MODE=auto
# Close factor execution mode: fixed50 or full (default: fixed50)
# fixed50: safer default, liquidates 50% of debt (reduces capital requirement & race risk)
# full: liquidates 100% of debt (experimental, higher capital requirement)
CLOSE_FACTOR_EXECUTION_MODE=fixed50
# Liquidation debt assets (comma-separated addresses to prioritize; optional)
# If not set, will use largest debt position by value
# LIQUIDATION_DEBT_ASSETS=0x...
# Minimum repay size in USD (default: 50) - opportunities below this are rejected before quoting
MIN_REPAY_USD=50
# Maximum target users to recheck per event tick (default: 100) - bounds event-driven rechecks
MAX_TARGET_USERS_PER_TICK=100

# Real-time HF Detection (runtime feature, opt-in)
# Master switch for real-time detection (default: false for safety)
USE_REALTIME_HF=false
# WebSocket RPC URL (required when USE_REALTIME_HF=true)
WS_RPC_URL=wss://mainnet.base.org
# Optional: enable pending block polling for faster triggers (default: false)
USE_FLASHBLOCKS=false
# Flashblocks WebSocket URL (optional, defaults to WS_RPC_URL)
# FLASHBLOCKS_WS_URL=wss://...
# Pending block polling interval in milliseconds (default: 250)
# FLASHBLOCKS_TICK_MS=250
# Multicall3 address on Base (default: 0xca11bde05977b3631167028862be2a173976ca11)
MULTICALL3_ADDRESS=0xca11bde05977b3631167028862be2a173976ca11
# Aave Pool address for health factor checks (default: Base V3 Pool)
AAVE_POOL=0xA238Dd80C259a72e81d7e4664a9801593F98d1c5
# Health factor threshold in basis points (9800 = 0.98, below which user is liquidatable)
EXECUTION_HF_THRESHOLD_BPS=9800
# Subgraph candidate refresh cadence with jitter (seconds, default: 45)
REALTIME_SEED_INTERVAL_SEC=45
# Max candidates to maintain in memory (default: 300)
CANDIDATE_MAX=300
# Hysteresis threshold in basis points (20 = 0.20%, HF must worsen by this much to re-emit)
HYSTERESIS_BPS=20
# Only notify when liquidation plan is actionable (resolved debt/collateral) (default: true)
NOTIFY_ONLY_WHEN_ACTIONABLE=true
# Prevent multiple concurrent executions for the same user (default: true)
EXECUTION_INFLIGHT_LOCK=true

# Timeout and Recovery Configuration
# Per-chunk timeout for multicall operations in milliseconds (default: 2000)
# If a chunk takes longer than this, it will be aborted and retried
CHUNK_TIMEOUT_MS=2000
# Number of retry attempts for timed-out chunks (default: 2)
# Total attempts = 1 initial + CHUNK_RETRY_ATTEMPTS retries
CHUNK_RETRY_ATTEMPTS=2
# Run-level stall detection timeout in milliseconds (default: 5000)
# If a run makes no progress for this duration, it will be aborted and restarted
RUN_STALL_ABORT_MS=5000
# WebSocket heartbeat interval in milliseconds (default: 15000)
# If no blocks or activity for this duration, WS connection will be reset
WS_HEARTBEAT_MS=15000

# Optional Secondary RPC for Head-Check Fallback
# Secondary RPC URL to use when primary times out (optional)
# SECONDARY_HEAD_RPC_URL=https://mainnet.base.org

# RPC-only Tuning and Stability Configuration
# Multicall batch size for sub-batch operations (default: 120)
# Increase for paid Alchemy plans (150-200 recommended), decrease if hitting rate limits
MULTICALL_BATCH_SIZE=120
# Enable adaptive adjustment of HEAD_CHECK_PAGE_SIZE based on latency/timeout rates (default: true)
HEAD_PAGE_ADAPTIVE=true
# Target maximum elapsed time per head page run in milliseconds (default: 900)
# Adaptive logic adjusts page size to keep within this target
HEAD_PAGE_TARGET_MS=900
# Lower bound on dynamic page size in candidates per block (default: 600)
HEAD_PAGE_MIN=600
# Upper bound for adaptive page size (default: HEAD_CHECK_PAGE_SIZE or 2400)
# HEAD_PAGE_MAX=2400
# Hedge window in milliseconds for early secondary provider race (default: 300, 0 disables)
# If set and SECONDARY_HEAD_RPC_URL is present, fire hedge request after this delay
# HEAD_CHECK_HEDGE_MS=300
# Debounce window in milliseconds to coalesce event triggers per block/reserve (default: 120)
EVENT_BATCH_COALESCE_MS=120
# Cap event-driven batch executions per block to avoid starvation (default: 2)
EVENT_BATCH_MAX_PER_BLOCK=2
# Maximum parallel event batches to avoid provider contention with head sweeps (default: 1)
MAX_PARALLEL_EVENT_BATCHES=1

# Real-time HF Harness Configuration (test-only utility)
# Comma-separated candidate user addresses for monitoring (harness only)
# CANDIDATE_USERS=0x123...,0x456...
# Alternative: use subgraph to seed candidates (requires GRAPH_API_KEY + SUBGRAPH_DEPLOYMENT_ID)
# Number of users to seed from subgraph (default: 50)
SEED_LIMIT=50
# Duration to run harness in seconds (default: 60)
HARNESS_DURATION_SEC=60
# Optional Chainlink price feeds for additional price-trigger subscriptions
# Format: TOKEN:FEED_ADDRESS,TOKEN:FEED_ADDRESS (e.g., ETH:0x71041dddad3595F9CEd3DcCFBe3D1F4b0a16Bb70,USDC:0x7e860098F58bBFC8648a4311b374B1D669a2bc6B)
# CHAINLINK_FEEDS=
